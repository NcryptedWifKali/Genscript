USE [910160US]
GO
/****** Object:  StoredProcedure [dbo].[TmSp_Inventory_Counting_GetCounterName]    Script Date: 03/05/2015 10:45:51 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[TmSp_Inventory_Counting_GetCounterName]
@DocKey@ nvarchar(12),
@ObjectId nvarchar(20),
@MultipleCounterType nvarchar(1) = 'I',
@MultipleCounterOrder nvarchar(12)
AS
BEGIN
Declare  @selectStr nvarchar(256)
Declare  @fromStr nvarchar(256)
Declare  @whereStr nvarchar(64)

Declare @CountingType nvarchar(1)

Declare  @taker1Type int

Declare  @typeUSR int = 12
Declare  @typeHEM int = 171
Declare  @CountTypeSingle nvarchar(1) = '1'
Declare  @CountTypeMultiple nvarchar(1) = '2'

Declare  @CounterTypeTeam nvarchar(1) = 'T'
Declare  @CounterTypeIndividual nvarchar(1) = 'I'

Declare  @MainTable nvarchar(16)
Declare  @Counter nvarchar(64)
Declare  @joinTbl nvarchar(16)
Declare  @joinCol nvarchar(16)

Declare @ResultCounterName nvarchar(16) = 'CounterName'

Declare @DocEntry nvarchar(16) = @DocKey@
Declare @CounterOrder nvarchar(16) = @MultipleCounterOrder

Set @whereStr = N' where T0.DocEntry=' + @DocEntry

IF (@ObjectId=1470000065)
	Begin
		select @CountingType = "T0"."CountType" from "OINC" "T0" where "T0"."DocEntry"=@DocKey@

		select @Taker1Type= "Taker1Type" from "OINC" where "DocEntry"=@DocKey@

		if (@CountingType = @CountTypeSingle )
		Begin
				select @Taker1Type= "Taker1Type" from "OINC" where "DocEntry"=@DocKey@
		        
				If(@taker1Type = @typeUSR)
				Begin
					 Set @Counter = ' "T1"."U_NAME" '
					 Set @joinTbl = ' "OUSR" '
					 Set @joinCol = ' "USERID" '
				End
				Else
				Begin
					 Set @Counter = ' "T1"."lastName"+'' ''+"T1"."firstName" '
					 Set @joinTbl = ' "OHEM" '
					 Set @joinCol = ' "empID" '
				End

				Set @selectStr = 'select ' + @Counter + ' as ' + @ResultCounterName + ' from "OINC"  "T0" ' +  ' join ' + @joinTbl + ' T1 on T0.Taker1Id = T1.' + @joinCol + @whereStr
		End
		Else
		Begin
				If(@MultipleCounterType = @CounterTypeTeam)
				Begin
					  Set @MainTable =' "INC4" "T0" '
				End
				Else
				Begin
					  Set @MainTable =' "INC8" "T0" '
				End
		       
			   Set @selectStr = 'select ' +  ' "T0"."CounteName" '+ ' as ' + @ResultCounterName + ' from '+ @MainTable  +  @whereStr + ' and "T0"."VisOrder" = ' + @CounterOrder
		End
	End
Else
	Begin
		select @CountingType = "T0"."CountType" from "OICD" "T0" where "T0"."DocEntry"=@DocEntry
		select @Taker1Type= "Taker1Type" from "OICD" where "DocEntry"=@DocEntry

		if (@CountingType = @CountTypeSingle )
		Begin
				select @Taker1Type= "Taker1Type" from "OICD" where "DocEntry"=@DocEntry
		        
				If(@taker1Type = @typeUSR)
				Begin
					 Set @Counter = ' "T1"."U_NAME" '
					 Set @joinTbl = ' "OUSR" '
					 Set @joinCol = ' "USERID" '
				End
				Else
				Begin
					 Set @Counter = ' "T1"."lastName"+'' ''+"T1"."firstName" '
					 Set @joinTbl = ' "OHEM" '
					 Set @joinCol = ' "empID" '
				End

				Set @selectStr = 'select ' + @Counter + ' as ' + @ResultCounterName + ' from "OICD"  "T0" ' +  ' join ' + @joinTbl + ' T1 on T0.Taker1Id = T1.' + @joinCol + @whereStr
		End
		Else
		Begin
				If(@MultipleCounterType = @CounterTypeTeam)
				Begin
					  Set @MainTable =' "ICD4" "T0" '
				End
				Else
				Begin
					  Set @MainTable =' "ICD8" "T0" '
				End
		       
			   Set @selectStr = 'select ' +  ' "T0"."CounteName" '+ ' as ' + @ResultCounterName + ' from '+ @MainTable  +  @whereStr + ' and "T0"."VisOrder" = ' + @CounterOrder
			   End
	End
exec (@selectStr)
END
/*
	Begin
		select @CountingType = "T0"."CountType" from "OICD" "T0" where "T0"."DocEntry"=@DocEntry
		select @Taker1Type= "Taker1Type" from "OICD" where "DocEntry"=@DocEntry

		if (@CountingType = @CountTypeSingle )
		Begin
				select @Taker1Type= "Taker1Type" from "OICD" where "DocEntry"=@DocEntry
		        
				If(@taker1Type = @typeUSR)
				Begin
					 Set @Counter = ' "T1"."U_NAME" '
					 Set @joinTbl = ' "OUSR" '
					 Set @joinCol = ' "USERID" '
				End
				Else
				Begin
					 Set @Counter = ' "T1"."lastName"+'' ''+"T1"."firstName" '
					 Set @joinTbl = ' "OHEM" '
					 Set @joinCol = ' "empID" '
				End

				Set @selectStr = 'select ' + @Counter + ' as ' + @ResultCounterName + ' from "OICD"  "T0" ' +  ' join ' + @joinTbl + ' T1 on T0.Taker1Id = T1.' + @joinCol + @whereStr
		End
		Else
		Begin
				If(@MultipleCounterType = @CounterTypeTeam)
				Begin
					  Set @MainTable =' "ICD4" "T0" '
				End
				Else
				Begin
					  Set @MainTable =' "ICD8" "T0" '
				End
		       
			   Set @selectStr = 'select ' +  ' "T0"."CounteName" '+ ' as ' + @ResultCounterName + ' from '+ @MainTable  +  @whereStr + ' and "T0"."VisOrder" = ' + @CounterOrder
	End
	END*/
